name: Cypress CI

on:
  push:
    branches:
      - main
      - master
      - feature/**
  workflow_dispatch:  # allows manual run

jobs:
  run-cypress:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Detect commit type
        id: detect
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "ðŸ“ Commit message: $COMMIT_MSG"

          # detect keywords safely
          FILE_KEYWORDS=$(echo "$COMMIT_MSG" | grep -oP '\[\K[^\]]+' || true)
          FILE_PATTERN=$(echo "$FILE_KEYWORDS" | sed 's/,/|/g')

          # detect run type
          if echo "$COMMIT_MSG" | grep -qi "RUN=ALL"; then
            echo "RUN_TYPE=ALL" >> $GITHUB_ENV
            echo "âœ… Detected RUN=ALL â†’ Running all tests"
            echo "specs=cypress/e2e/**/*.cy.js" >> $GITHUB_OUTPUT
          elif echo "$COMMIT_MSG" | grep -qi "RUN=SPECIFIC"; then
            echo "RUN_TYPE=SPECIFIC" >> $GITHUB_ENV
            if [ -z "$FILE_PATTERN" ]; then
              echo "âš ï¸ RUN=SPECIFIC found but no file keywords â†’ running all tests"
              echo "specs=cypress/e2e/**/*.cy.js" >> $GITHUB_OUTPUT
            else
              echo "âœ… Detected RUN=SPECIFIC â†’ files: $FILE_PATTERN"
              echo "specs=cypress/e2e/*($FILE_PATTERN)*.cy.js" >> $GITHUB_OUTPUT
            fi
          else
            echo "â­ï¸ No RUN=ALL or RUN=SPECIFIC â†’ Skipping tests"
            echo "skip_tests=true" >> $GITHUB_ENV
          fi

      - name: Run Cypress tests
        if: env.skip_tests != 'true'
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          spec: ${{ steps.detect.outputs.specs }}
